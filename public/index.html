<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPU Çoban – Panel (Debug Build)</title>
  <style>
    :root{ --bg:#131722; --panel:#171b26; --muted:#a8b3c2; --text:#e8eef6; --brand:#f26b1d; --line:#232a36; --badge:#1a2030; }
    html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px}
    .badge{display:inline-block;padding:4px 8px;background:var(--badge);border:1px solid var(--line);border-radius:999px;margin-right:6px}
    .err{background:#3a1f21;border-color:#6a2a2f;color:#ffd4d4}
    a{color:#5aa6ff;text-decoration:none}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <div>
        <div style="font-weight:800">GPU Çoban – Panel <span class="muted">(Debug)</span></div>
        <div class="muted">Miner bağımsız telemetri → <code>rigs.json</code> → Panel</div>
      </div>
      <div>
        <a class="badge" href="#" id="refreshBtn">Yenile</a>
        <a class="badge" href="./rigs.json" target="_blank">JSON’u Gör</a>
      </div>
    </div>
    <div id="alert"></div>
    <div id="view" class="card">Yükleniyor…</div>
  </div>

  <script>
  (function(){
    function showError(msg){
      var a = document.getElementById('alert');
      a.innerHTML = '<div class="badge err">⚠️ '+String(msg)+'</div>';
      console.error('[Panel]', msg);
    }
    function safe(fn){
      try{ fn(); }catch(e){ showError(e && e.message ? e.message : e); }
    }
    function fetchJSON(url){
      return fetch(url + (url.indexOf('?')>-1?'&':'?') + 'ts=' + Date.now()).then(function(res){
        if(!res.ok) throw new Error('JSON yüklenemedi ('+res.status+')');
        return res.json();
      });
    }
    function fmt(n){ return (typeof n==='number') ? n.toFixed(2) : '—'; }
    function renderList(rigs){
      var html = '<div class="muted" style="margin-bottom:8px">Rig sayısı: '+rigs.length+'</div>';
      html += '<div class="card" style="overflow:auto"><table border="0" cellpadding="8"><thead>'+
              '<tr><th>Rig ID</th><th>Ad</th><th>GPU</th><th>Toplam Hash</th><th>Toplam Güç</th></tr></thead><tbody>';
      for(var i=0;i<rigs.length;i++){
        var r = rigs[i]; var gcount = (r.gpus && r.gpus.length) ? r.gpus.length : 0;
        var mh = 0, w = 0;
        if (r.gpus){ for(var j=0;j<r.gpus.length;j++){ var g=r.gpus[j]; if(typeof g.hash_mhs==='number') mh += g.hash_mhs; if(typeof g.power_w==='number') w += g.power_w; } }
        html += '<tr><td>'+r.rig_id+'</td><td>'+(r.name||'—')+'</td><td>'+gcount+'</td><td>'+fmt(mh)+' MH/s</td><td>'+Math.round(w)+' W</td></tr>';
      }
      html += '</tbody></table></div>';
      document.getElementById('view').innerHTML = html;
    }
    function normalize(data){
      return Array.isArray(data) ? data : (data && Array.isArray(data.rigs) ? data.rigs : []);
    }
    function load(force){
      safe(function(){
        console.log('[Panel] load()', force);
        fetchJSON('rigs.json' + (force? '?cache='+Math.random() : '')).then(function(data){
          console.log('[Panel] rigs.json OK:', data);
          var rigs = normalize(data);
          renderList(rigs);
        }).catch(function(e){
          showError(e && e.message ? e.message : e);
          document.getElementById('view').textContent = 'Veri yüklenemedi.';
        });
      });
    }
    document.getElementById('refreshBtn').addEventListener('click', function(e){ e.preventDefault(); load(true); });
    // Boot
    console.log('[Panel] JS OK, booting…');
    load(false);
  })();
  </script>
</body>
</html>
